# Common compiler for MSVC (cl.exe, clang-cl)
# This 'msvc-generic' defines default compiler and linker flags, feature sets,
# and mutually exclusive categories that apply to any MSVC variant.
# Individual compiler (like cl or clangcl) will extends this compiler to
# inherit its configuration, avoiding duplication.
compilers:
  msvc-generic:
    # This compiler is not a compiler that can be used to build
    is_abstract: true
    profiles:
      msvc-generic:
        is_abstract: true
        enable-features: [WARNING_STRICT, ENABLE_EXCEPTION]
      debug:
        extends: msvc-generic
        enable-features: [OPT_LEVEL_0, ENABLE_INCREMENTAL_LINK, WINDOWS_DLL_RUNTIME_DEBUG]
        dyn:
          enable-features: [DYNAMIC_LIBRARY_DEBUG]
      release:
        extends: msvc-generic
        enable-features: [OPT_LEVEL_3, REMOVE_DEAD_CODE, DISABLE_INCREMENTAL_LINK, WINDOWS_DLL_RUNTIME_RELEASE]
        dyn:
          enable-features: [DYNAMIC_LIBRARY_RELEASE]
    features:
      # Dynmaci library
      - name: DYNAMIC_LIBRARY_RELEASE
        description: Generate a dynamic library in release
        cxx-compiler-flags: [/LD]
      - name: DYNAMIC_LIBRARY_DEBUG
        description: Generate a dynamic library in debug
        cxx-compiler-flags: [/LDd]

      # Remove dead code
      - name: REMOVE_DEAD_CODE
        description: Remove dead code
        cxx-linker-flags: [/OPT:REF, /OPT:ICF]

      # Warnings
      - name: WARNING_BASE
        description: Default warning level
        cxx-compiler-flags: [/W3]
      - name: WARNING_STRICT
        description: Strict warnings
        cxx-compiler-flags: [/W4]
      - name: WARNING_ALL
        description: All warnings (very noisy)
        cxx-compiler-flags: [/Wall]
      - name: WARNING_AS_ERROR
        description: Treat warnings as errors
        cxx-compiler-flags: [/WX]
      - name: NO_WARNING
        description: Disable all warnings
        cxx-compiler-flags: [/W0]

      # Windows Runtime
      - name: WINDOWS_DLL_RUNTIME_DEBUG
        description: Windows CRT dynamic runtime in debug (MSVCRTD.lib)
        cxx-compiler-flags: [/MDd]
      - name: WINDOWS_DLL_RUNTIME_RELEASE
        description: Windows CRT dynamic runtime in release (MSVCRT.lib)
        cxx-compiler-flags: [/MD]
      - name: WINDOWS_STATIC_RUNTIME_DEBUG
        description: Windows CRT static runtime in debug (LIBCMTD.lib)
        cxx-compiler-flags: [/MTd]
      - name: WINDOWS_STATIC_RUNTIME_RELEASE
        description: Windows CRT static runtime in release (LIBCMT.lib)
        cxx-compiler-flags: [/MT]

      # Optimisations
      - name: OPT_LEVEL_0
        description: No optimization
        cxx-compiler-flags: [/Od]
        cxx-linker-flags: [/DEBUG]
        enable-features: [DEBUG_INFO]
      - name: OPT_LEVEL_1
        description: Minimal optimization
        cxx-compiler-flags: [/O1]
      - name: OPT_LEVEL_2
        description: Default optimization
        cxx-compiler-flags: [/O2]
      - name: OPT_LEVEL_3
        description: Max optimization
        cxx-compiler-flags: [/O2, /Ob2, /Oi]
        enable-features: [LTO, OMIT_FRAME_POINTER]
      - name: LTO
        description: Whole program optimization
        cxx-compiler-flags: [/GL]
        cxx-linker-flags: [/LTCG]
      - name: OMIT_FRAME_POINTER
        description: Omit frame pointer
        cxx-compiler-flags: [/Oy]

      # Debug informations
      - name: DEBUG_INFO
        description: Generate debug informations
        cxx-compiler-flags: [/Zi]

      # Exception
      - name: ENABLE_EXCEPTION
        description: Enable C++ exception
        cxx-compiler-flags: [/EHsc]
      - name: DISABLE_EXCEPTION
        description: Disable C++ exception
        cxx-compiler-flags: [/EH-]

      # Incremental link
      - name: ENABLE_INCREMENTAL_LINK
        description: Enable incremental linking
        cxx-linker-flags: [/INCREMENTAL]
      - name: DISABLE_INCREMENTAL_LINK
        description: Disable incremental linking
        cxx-linker-flags: [/INCREMENTAL:NO]

      # Target Architecture
      - name: TARGET_X64
        description: Enable 64 bits (AMD64 / Intel64) link
        cxx-linker-flags: [/MACHINE:X64]
      - name: TARGET_X86
        description: Enable 32 bits (x86) link
        cxx-linker-flags: [/MACHINE:X86]

    # Features rules
    # only-one rule : Only 1 rules is allowed in 'features'. Multiple in the same target is not allowed.
    # incompatible : The 'feature' is incompatible with all feature in 'with'
    feature-rules:
      # Only one warning level at a time
      - only-one: warning
        features: [WARNING_BASE, WARNING_STRICT, WARNING_ALL, NO_WARNING]
      # Only one runtime at a time
      - only-one: runtime
        features: [WINDOWS_DLL_RUNTIME_DEBUG, WINDOWS_DLL_RUNTIME_RELEASE, WINDOWS_STATIC_RUNTIME_DEBUG, WINDOWS_STATIC_RUNTIME_RELEASE]
      # Only one optimization level at a time
      - only-one: optimization
        features: [OPT_LEVEL_0, OPT_LEVEL_1, OPT_LEVEL_2, OPT_LEVEL_3]
      # OPT_LEVEL_0 is incompatible with LTO, OMIT_FRAME_POINTER
      - incompatible: no_opt
        feature: OPT_LEVEL_0
        with: [LTO, OMIT_FRAME_POINTER]
      # Only one exceptions mode
      - only-one: exceptions
        features: [ENABLE_EXCEPTION, DISABLE_EXCEPTION]
      # Only one incremental link mode
      - only-one: incremental
        features: [ENABLE_INCREMENTAL_LINK, DISABLE_INCREMENTAL_LINK]
      # Only one target mode
      - only-one: target
        features: [TARGET_X64, TARGET_X86]
      # Only one dynamic library mode
      - only-one: dll
        features: [DYNAMIC_LIBRARY_RELEASE, DYNAMIC_LIBRARY_DEBUG]

  # MSVC cl.exe compiler
  cl:
    extends: msvc-generic
    profiles:
      custom:
        extends: debug
        enable-features: [ASAN]
    features:
      - name: ASAN
        description: Enable ASAN Sanitizer (Clang-cl only)
        cxx-compiler-flags: ["/fsanitize=address"]
        enable-features: [DEBUG_INFO, WINDOWS_DLL_RUNTIME_DEBUG, DISABLE_INCREMENTAL_LINK]
    feature-rules:
      - incompatible: asan
        feature: ASAN
        with: [OPT_LEVEL_3, LTO, OMIT_FRAME_POINTER]

  # MSVC clang-cl compiler
  clangcl:
    extends: msvc-generic

    profiles:
      debug:
        enable-features: [ASAN]
      custom:
        extends: debug
    features:
      - name: ASAN
        description: Enable ASAN Sanitizer (Clang-cl only)
        cxx-compiler-flags: ["-fsanitize=address", "-fsanitize-address-use-after-scope"]
        enable-features: [DEBUG_INFO, WINDOWS_DLL_RUNTIME_RELEASE]
    feature-rules:
      - incompatible: asan
        feature: ASAN
        with: [OPT_LEVEL_3, LTO, OMIT_FRAME_POINTER]
