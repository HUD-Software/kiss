# Common compiler for MSVC (cl.exe, clang-cl)
# This 'msvc-generic' defines default compiler and linker flags, feature sets,
# and mutually exclusive categories that apply to any MSVC variant.
# Individual compiler (like cl or clangcl) will extends this compiler to
# inherit its configuration, avoiding duplication.
compilers:
  msvc-generic:
    # This compiler is not a compiler that can be used to build
    is_abstract: true
    profiles:
      common:
        is_abstract: true
        enable-features: [WARNING_STRICT, RUNTIME_DLL, ENABLE_EXCEPTION]
      debug:
        extends: common
        enable-features: [OPT_LEVEL_0, WARNING_ALL]
        cxx-compiler-flags: []
        cxx-linker-flags: [/INCREMENTAL]
        dyn:
          cxx-compiler-flags: [/LDd]
      release:
        extends: common
        enable-features: [OPT_LEVEL_3]
        cxx-linker-flags: [/OPT:REF, /OPT:ICF, /INCREMENTAL:NO]
        dyn:
          cxx-compiler-flags: [/LD]
          enable-features: [WARNING_ALL]
    features:
      # Warnings
      - name: WARNING_BASE
        description: Default warning level
        cxx-compiler-flags: [/W3]
      - name: WARNING_STRICT
        description: Strict warnings
        cxx-compiler-flags: [/W4]
      - name: WARNING_ALL
        description: All warnings (very noisy)
        cxx-compiler-flags: [/Wall]
      - name: WARNING_AS_ERROR
        description: Treat warnings as errors
        cxx-compiler-flags: [/WX]
      - name: NO_WARNING
        description: Disable all warnings
        cxx-compiler-flags: [/W0]

      # Windows Runtime
      - name: RUNTIME_DLL
        description: Windows DLL runtime
        profiles:
          debug:
            cxx-compiler-flags: [/MTd]
          release:
            cxx-compiler-flags: ["/MD"]
      - name: RUNTIME_STATIC
        description: Windows static runtime
        # Apply to all configuration
        cxx-compiler-flags: []
        cxx-linker-flags: []
        enable-features: []
        profiles:
          debug:
            cxx-compiler-flags: [/MTd]
            cxx-linker-flags: []
          release:
            cxx-compiler-flags: [/MT]
            cxx-linker-flags: []

      # Optimisations
      - name: OPT_LEVEL_0
        description: No optimization (debug-like)
        cxx-compiler-flags: [/Od]
        cxx-linker-flags: [/DEBUG]
        enable-features: [DEBUG_INFO]
      - name: OPT_LEVEL_1
        description: Minimal optimization (-O1)
        cxx-compiler-flags: [/O1]
      - name: OPT_LEVEL_2
        description: Default optimization (-O2)
        cxx-compiler-flags: [/O2]
      - name: OPT_LEVEL_3
        description: Max optimization (-O2 + aggressive inline)
        cxx-compiler-flags: [/O2, /Ob2, /Oi]
        enable-features: [LTO, OMIT_FRAME_POINTER, LTCG]
      - name: LTCG
        description: Link-time code generation
        cxx-linker-flags: [/LTCG]
      - name: LTO
        description: Whole program optimization
        cxx-compiler-flags: [/GL]
      - name: OMIT_FRAME_POINTER
        description: Omit frame pointer
        cxx-compiler-flags: [/Oy]

      # Debug informations
      - name: DEBUG_INFO
        description: Generate debug informations
        cxx-compiler-flags: [/Zi]

      # Exception
      - name: ENABLE_EXCEPTION
        description: Enable C++ exception
        cxx-compiler-flags: [/EHsc]
      - name: DISABLE_EXCEPTION
        description: Disable C++ exception
        cxx-compiler-flags: [/EH-]

      # Target Architecture
      - name: TARGET_X64
        description: Enable 64 bits (AMD64 / Intel64) link
        cxx-linker-flags: [/MACHINE:X64]

    # Features rules
    # only-one rule : Only 1 rules is allowed in 'features'. Multiple in the same target is not allowed.
    # incompatible : The 'feature' is incompatible with all feature in 'with'
    feature-rules:
      # Only one warning level at a time
      - only-one: warning
        features: [WARNING_BASE, WARNING_STRICT, WARNING_ALL, NO_WARNING]
      # Only one runtime at a time
      - only-one: runtime
        features: [RUNTIME_DLL, RUNTIME_STATIC]
      # Only one optimization level at a time
      - only-one: optimization
        features: [OPT_LEVEL_0, OPT_LEVEL_1, OPT_LEVEL_2, OPT_LEVEL_3]
      # OPT_LEVEL_0 is incompatible with LTCG, LTO, OMIT_FRAME_POINTER
      - incompatible: no_opt
        feature: OPT_LEVEL_0
        with: [LTCG, LTO, OMIT_FRAME_POINTER]
      # Only one exceptions mode
      - only-one: exceptions
        features: [ENABLE_EXCEPTION, DISABLE_EXCEPTION]
  # MSVC clang-cl compiler
  clangcl:
    extends: msvc-generic
    profiles:
      common:
        is_abstract: true
        enable-features: [TARGET_X64]
      debug:
        extends: common
        enable-features: [ASAN]
      release:
        extends: common
        bin:
          enable-features: [WARNING_BASE]
      custom:
        extends: release
    features:
      - name: ASAN
        description: Enable ASAN Sanitizer (Clang-cl only)
        cxx-compiler-flags: ["-fsanitize=address", "-fsanitize-address-use-after-scope"]
        cxx-linker-flags: ["-fsanitize=address"]
        # ASAN require to enable some features to work correctly
        enable-features: [DEBUG_INFO, RUNTIME_DLL]
    feature-rules:
      - incompatible: asan
        feature: ASAN
        with: [OPT_LEVEL_3, LTO, OMIT_FRAME_POINTER, LTCG]
